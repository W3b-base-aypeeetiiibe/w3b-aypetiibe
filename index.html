<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NZM IPTV ‚Äî Clean Player</title>

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#071025" />
  <link rel="icon" href="nzm.png">

  <!-- HLS + DASH -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.0/hls.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.6/shaka-player.compiled.min.js"></script>

  <!-- Channels -->
  <script src="channels.js"></script>

  <style>
  :root{
    --bg:#08112e;
    --panel:rgba(255,255,255,0.05);
    --glass:rgba(255,255,255,0.04);
    --accent1:#1f80ff;
    --accent2:#0062ff;
    --text:#e6f2ff;
    --muted:rgba(200,220,255,0.6);
    --neon:0 6px 24px rgba(0,98,255,0.1),0 4px 10px rgba(31,128,255,0.08);
  }
  html,body{
    margin:0;height:100%;
    background:radial-gradient(circle at top,#0a1747 0%,#050a1c 100%);
    color:var(--text);overflow:hidden;
  }
  *{box-sizing:border-box;font-family:Inter,Poppins,Arial,sans-serif}
  .app{display:flex;flex-direction:column;height:100vh;overflow:hidden}
  .topbar{
    display:flex;align-items:center;justify-content:space-between;
    padding:12px 18px;
    backdrop-filter:blur(8px) saturate(1.1);
    background:linear-gradient(180deg,rgba(255,255,255,0.04),rgba(255,255,255,0.02));
    border-bottom:1px solid rgba(255,255,255,0.05);
    box-shadow:0 6px 30px rgba(0,0,0,0.6);
  }
  .brand{display:flex;gap:12px;align-items:center}
  .brand img{height:38px;border-radius:8px;filter:drop-shadow(0 6px 18px rgba(0,0,0,0.6));}
  .brand h1{font-size:18px;color:var(--accent1);margin:0;text-shadow:0 2px 10px rgba(0,0,0,0.6)}
  .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
  .search{
    min-width:220px;display:flex;align-items:center;padding:8px 12px;
    background:rgba(255,255,255,0.05);
    border-radius:26px;gap:10px;border:1px solid rgba(255,255,255,0.05);
    backdrop-filter:blur(6px);
  }
  .search input{background:transparent;border:none;outline:none;color:var(--text);width:100%;font-size:14px}
  .btn{
    padding:8px 12px;border-radius:12px;background:transparent;
    border:1px solid rgba(255,255,255,0.04);
    cursor:pointer;color:var(--text);font-weight:600;backdrop-filter:blur(4px);
  }
  .btn.glow{
    box-shadow:var(--neon);
    background:linear-gradient(90deg,rgba(0,210,255,0.08),rgba(106,92,255,0.06));
  }
  .content{flex:1;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:18px}
  .row{display:flex;flex-direction:column;gap:10px}
  .row-header{display:flex;align-items:center;justify-content:space-between;padding:0 6px}
  .row-title{font-size:16px;color:var(--muted)}
  .carousel{display:flex;gap:12px;overflow:auto;padding:12px 6px;scroll-snap-type:x mandatory;scroll-behavior:smooth}
  .carousel::-webkit-scrollbar{height:8px}
  .carousel::-webkit-scrollbar-thumb{background:linear-gradient(90deg,var(--accent1),var(--accent2));border-radius:8px}
  .card{min-width:220px;height:132px;border-radius:12px;
    background:rgba(255,255,255,0.03);
    display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;
    padding:10px;cursor:pointer;position:relative;scroll-snap-align:center;
    transition:transform .18s ease,box-shadow .18s ease;
    border:1px solid rgba(255,255,255,0.04)
  }
  .card:hover{transform:translateY(-6px) scale(1.03);box-shadow:0 14px 40px rgba(0,0,0,0.6)}
  .card img{width:110px;height:70px;border-radius:8px;object-fit:cover}
  .card .name{font-size:14px;color:var(--text);text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%}
  .badge-live{position:absolute;left:10px;top:10px;background:linear-gradient(90deg,var(--accent1),var(--accent2));padding:4px 6px;border-radius:6px;font-size:11px;color:#fff}
  .fav-toggle{position:absolute;right:10px;top:10px;background:rgba(0,0,0,0.45);padding:6px;border-radius:8px;color:var(--accent1);cursor:pointer}
  .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(3,6,12,0.7),rgba(0,0,0,0.9));z-index:100}
  .overlay.active{display:flex}
  .player-wrap{width:92%;max-width:1280px;aspect-ratio:16/9;background:#000;border-radius:14px;overflow:hidden;position:relative;box-shadow:0 30px 80px rgba(0,0,0,0.7)}
  video,iframe{width:100%;height:100%;display:block;background:#000}
  .close-btn{position:absolute;left:12px;top:12px;background:rgba(0,0,0,0.6);padding:8px;border-radius:10px;color:#fff;cursor:pointer;z-index:40}
  .now-playing-box{
    position:absolute;left:60px;top:12px;display:flex;align-items:center;gap:8px;
    background:rgba(0,0,0,0.6);padding:8px 10px;border-radius:10px;color:#fff;
    backdrop-filter:blur(4px);z-index:40;
  }
  .now-playing-box img{width:44px;height:30px;object-fit:cover;border-radius:6px}
  .steady-banner{
    position:absolute;top:14px;right:14px;display:flex;align-items:center;gap:10px;
    padding:8px 12px;border-radius:10px;background:rgba(0,0,0,0.6);color:#fff;z-index:60;
    backdrop-filter:blur(6px);font-weight:600;font-size:14px;
    box-shadow:0 8px 30px rgba(0,0,0,0.6);
  }
  .steady-banner img{width:44px;height:30px;border-radius:6px;object-fit:cover}
  .player-controls-bottom{position:absolute;right:16px;bottom:16px;display:flex;gap:8px;z-index:50;align-items:center;}
  .player-controls-bottom button{background:rgba(0,0,0,0.5);border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;backdrop-filter:blur(4px);font-size:16px;}
  video::-webkit-media-controls{display:none!important}
  .video-channel-list{
    position:absolute;top:0;right:-320px;width:300px;height:100%;
    background:rgba(0,0,0,0.55);
    backdrop-filter:blur(12px);
    border-left:1px solid rgba(255,255,255,0.08);
    box-shadow:-4px 0 30px rgba(0,0,0,0.6);
    transition:right .4s ease;z-index:75;display:flex;flex-direction:column;
  }
  .video-channel-list.active{right:0;}
  .channel-list-header{
    font-size:18px;font-weight:600;color:var(--accent1);
    padding:16px;border-bottom:1px solid rgba(255,255,255,0.1);
    background:rgba(0,0,0,0.4);
    text-shadow:0 0 12px rgba(31,128,255,0.5);
  }
  .channel-list-container{flex:1;overflow-y:auto;padding:10px 0;}
  .channel-item{display:flex;align-items:center;gap:10px;padding:10px 16px;color:#fff;opacity:.85;cursor:pointer;transition:background .2s ease,opacity .2s ease;}
  .channel-item:hover{background:rgba(255,255,255,0.12);opacity:1;}
  .channel-item img{width:44px;height:30px;object-fit:cover;border-radius:6px;}
  .channel-item span{flex:1;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand"><img src="nzmm.png"><h1>NZM IPTV</h1></div>
      <div class="controls">
        <div class="search">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <input id="searchInput" placeholder="Search channels or categories (press / to focus)"/>
        </div>
        <button id="installBtn" class="btn glow" style="display:none;">üì≤ Install</button>
        <button id="favoritesTab" class="btn glow">‚ù§ Favorites</button>
      </div>
    </div>

    <div class="content" id="content"></div>

    <div id="installPopup" style="display:none;position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;padding:12px 18px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.6);z-index:9999;font-weight:500;">
      Install NZM IPTV for quick access üì≤
      <button id="popupInstall" class="btn" style="background:#fff;color:#000;margin-left:8px;">Install</button>
    </div>

    <div class="mini-player" id="miniPlayer" style="display:none;position:fixed;right:12px;bottom:12px;background:rgba(0,0,0,0.5);padding:8px;border-radius:10px;display:flex;gap:8px;align-items:center;border:1px solid rgba(255,255,255,0.05);box-shadow:0 8px 28px rgba(0,0,0,0.6);z-index:9999;">
      <img id="miniLogo" src="" alt="logo" style="width:56px;height:36px;border-radius:6px;object-fit:cover;">
      <div class="meta">
        <div class="t" id="miniTitle" style="font-weight:600">‚Äî</div>
        <div class="muted" id="miniType" style="font-size:12px;color:var(--muted)">‚Äî</div>
      </div>
      <div style="display:flex;gap:8px;margin-left:8px">
        <button id="miniOpen" class="btn">‚§¢</button>
        <button id="miniClose" class="btn">‚úñ</button>
      </div>
    </div>

    <div class="overlay" id="overlay" aria-hidden="true">
      <div class="player-wrap" id="playerWrap">
        <button class="close-btn" id="exitPlayer">‚úñ</button>
        <div class="now-playing-box" id="nowPlayingUI"><img id="nowLogo"><div id="nowTitle">‚Äî</div></div>
        <div class="steady-banner" id="steadyBanner"><img id="steadyLogo" src="logo.png"><div id="steadyTitle">‚Äî</div></div>
        <div class="player-controls-bottom"><button id="minimizeBtn">üì∫</button></div>
        <div id="loadingSpinner" class="loading-spinner" style="position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:60;"><div class="spinner" style="width:56px;height:56px;border:6px solid rgba(255,255,255,0.12);border-top-color:var(--accent1);border-radius:50%;animation:spin .8s linear infinite;"></div></div>
        <video id="playerVideo" playsinline preload="auto" style="background:#000;outline:none;" controlslist="nodownload noremoteplayback nofullscreen noplaybackrate"></video>
        <iframe id="playerIframe" allowfullscreen style="display:none;"></iframe>
        <!-- right-side channel list -->
        <div class="video-channel-list" id="videoChannelList">
          <div class="channel-list-header">üì∫ All Channels</div>
          <div class="channel-list-container" id="channelListContainer"></div>
        </div>
      </div>
    </div>
  </div>
<script>
  let favorites = JSON.parse(localStorage.getItem('iptv_favs') || '[]');
let lastPlayed = JSON.parse(localStorage.getItem('lastPlayed') || 'null');

const content = document.getElementById('content'),
      overlay = document.getElementById('overlay'),
      playerVideo = document.getElementById('playerVideo'),
      playerIframe = document.getElementById('playerIframe'),
      nowLogo = document.getElementById('nowLogo'),
      nowTitle = document.getElementById('nowTitle'),
      steadyLogo = document.getElementById('steadyLogo'),
      steadyTitle = document.getElementById('steadyTitle'),
      exitPlayer = document.getElementById('exitPlayer'),
      minimizeBtn = document.getElementById('minimizeBtn'),
      miniPlayer = document.getElementById('miniPlayer'),
      miniLogo = document.getElementById('miniLogo'),
      miniTitle = document.getElementById('miniTitle'),
      miniOpen = document.getElementById('miniOpen'),
      miniClose = document.getElementById('miniClose'),
      favoritesTab = document.getElementById('favoritesTab');

let hls = null, shakaPlayer = null;

/* =============== Basic Helpers =============== */
function showSpinner(){ document.getElementById('loadingSpinner').style.display='flex'; }
function hideSpinner(){ document.getElementById('loadingSpinner').style.display='none'; }

function stopAllPlayers(){
  if(hls){ try{hls.destroy();}catch(e){} hls=null; }
  if(shakaPlayer){ try{shakaPlayer.unload();}catch(e){} shakaPlayer=null; }
  try{ playerVideo.pause(); playerVideo.removeAttribute('src'); playerVideo.load(); }catch(e){}
  playerIframe.src=''; playerVideo.style.display='none'; playerIframe.style.display='none'; hideSpinner();
}

/* =============== Player Opening =============== */
async function openPlayer(ch){
  stopAllPlayers();
  overlay.classList.add('active');
  overlay.setAttribute('aria-hidden','false');
  showSpinner();

  nowLogo.src = steadyLogo.src = ch.logo || 'logo.png';
  nowTitle.textContent = steadyTitle.textContent = ch.name || '‚Äî';
  lastPlayed = {name:ch.name,url:ch.url,type:ch.type,logo:ch.logo,time:new Date().toLocaleString(),clearKey:ch.clearKey||null};
  localStorage.setItem('lastPlayed', JSON.stringify(lastPlayed));

  playerVideo.volume = 1;
  playerVideo.style.display='none';
  playerIframe.style.display='none';

  const wrap=document.getElementById('playerWrap');
  try{
    if(wrap.requestFullscreen) await wrap.requestFullscreen();
    else if(wrap.webkitRequestFullscreen) await wrap.webkitRequestFullscreen();
    if(screen.orientation && screen.orientation.lock) await screen.orientation.lock('landscape').catch(()=>{});
  }catch{}

  try{
    if(ch.type==='youtube'){
      playerIframe.style.display='block';
      playerIframe.src = ch.url + (ch.url.includes('?')?'&':'?')+'autoplay=1';
      hideSpinner();
    }else if(ch.type==='hls'){
      playerVideo.style.display='block';
      if(Hls.isSupported()){
        hls = new Hls({maxRetries:3});
        hls.attachMedia(playerVideo);
        hls.on(Hls.Events.MANIFEST_PARSED,()=>{hideSpinner();playerVideo.play().catch(()=>{});});
        hls.on(Hls.Events.ERROR,(evt,data)=>{if(data.fatal){hls.destroy();hideSpinner();}});
        hls.loadSource(ch.url);
      }else{
        playerVideo.src = ch.url;
        playerVideo.play().catch(()=>{});
        hideSpinner();
      }
    }else if(ch.type==='dash'){
      playerVideo.style.display='block';
      shaka.polyfill.installAll();
      shakaPlayer = new shaka.Player(playerVideo);
      if(ch.clearKey) shakaPlayer.configure({ drm:{ clearKeys: ch.clearKey } });
      shakaPlayer.addEventListener('buffering',e=>{ e.buffering?showSpinner():hideSpinner(); });
      await shakaPlayer.load(ch.url);
      playerVideo.play().catch(()=>{});
      hideSpinner();
    }else{
      playerVideo.style.display='block';
      playerVideo.src = ch.url;
      playerVideo.play().catch(()=>{});
      hideSpinner();
    }
  }catch(err){ console.error(err); hideSpinner(); }

  miniPlayer.style.display='flex';
  miniLogo.src = ch.logo || 'logo.png';
  miniTitle.textContent = ch.name || '‚Äî';
}

/* =============== Controls =============== */
exitPlayer.onclick = async ()=>{
  try{ if(document.fullscreenElement) await document.exitFullscreen(); }catch(e){}
  stopAllPlayers();
  overlay.classList.remove('active');
  overlay.setAttribute('aria-hidden','true');
};

minimizeBtn.onclick = async ()=>{
  try{
    if(playerVideo && playerVideo.requestPictureInPicture){
      await playerVideo.requestPictureInPicture();
      overlay.classList.remove('active');
      overlay.setAttribute('aria-hidden','true');
    }else{
      overlay.classList.remove('active');
      overlay.setAttribute('aria-hidden','true');
      miniPlayer.style.display='flex';
    }
  }catch{
    overlay.classList.remove('active');
    overlay.setAttribute('aria-hidden','true');
    miniPlayer.style.display='flex';
  }
};

miniOpen.onclick = ()=>{
  overlay.classList.add('active');
  overlay.setAttribute('aria-hidden','false');
  try{ if(document.pictureInPictureElement) document.exitPictureInPicture().catch(()=>{}); }catch(e){}
  miniPlayer.style.display='none';
};
miniClose.onclick = ()=>{ stopAllPlayers(); miniPlayer.style.display='none'; };

/* =============== UI Rendering =============== */
function groupChannels(list){
  const g={};
  (list||[]).forEach(c=>{
    const cat=c.category||c.group||c['group-title']||'Uncategorized';
    if(!g[cat]) g[cat]=[];
    g[cat].push(c);
  });
  return g;
}
function createRow(title,chs){
  const r=document.createElement('div');
  r.className='row';
  const h=document.createElement('div');
  h.className='row-header';
  h.innerHTML=`<div class="row-title"><strong>${title}</strong></div>
               <div><button class="btn" onclick="scrollRow(this,-1)">‚óÄ</button>
               <button class="btn" onclick="scrollRow(this,1)">‚ñ∂</button></div>`;
  const car=document.createElement('div');
  car.className='carousel';
  chs.forEach(c=>{
    const card=document.createElement('div');
    card.className='card';
    card.innerHTML=`${c.live?'<div class="badge-live">LIVE</div>':''}
      <div class="fav-toggle" data-name="${c.name}">
        ${favorites.includes(c.name)?'‚ù§':'‚ô°'}
      </div>
      <img src="${c.logo||'logo.png'}">
      <div class="name">${c.name}</div>`;
    card.addEventListener('click',e=>{
      if(e.target.closest('.fav-toggle')) return;
      openPlayer(c);
    });
    card.querySelector('.fav-toggle').addEventListener('click',ev=>{
      ev.stopPropagation();
      toggleFav(c.name,ev.target);
    });
    car.appendChild(card);
  });
  r.appendChild(h); r.appendChild(car); content.appendChild(r);
}
function toggleFav(n,el){
  const i=favorites.indexOf(n);
  if(i===-1){ favorites.push(n); el.textContent='‚ù§'; }
  else{ favorites.splice(i,1); el.textContent='‚ô°'; }
  localStorage.setItem('iptv_favs',JSON.stringify(favorites));
}
function scrollRow(b,d){ b.closest('.row-header').nextElementSibling.scrollBy({left:d*420,behavior:'smooth'}); }
function renderHome(f=''){
  content.innerHTML='';
  const g=groupChannels(combinedChannels||[]);
  const favs=(combinedChannels||[]).filter(c=>favorites.includes(c.name));
  if(favs.length) createRow('Favorites',favs);
  Object.keys(g).forEach(cat=>{
    const rows=g[cat].filter(ch=>ch.name.toLowerCase().includes(f.toLowerCase())||cat.toLowerCase().includes(f.toLowerCase()));
    if(rows.length) createRow(cat,rows);
  });
}
favoritesTab.onclick=()=>renderHome('');
searchInput.oninput=e=>renderHome(e.target.value||'');

document.addEventListener('keydown',e=>{
  if(e.key==='/'){e.preventDefault();searchInput.focus();}
  if(e.key==='Escape'&&overlay.classList.contains('active')) exitPlayer.click();
});

/* =============== Right-Side Channel List =============== */
const videoChannelList=document.getElementById('videoChannelList');
const channelListContainer=document.getElementById('channelListContainer');
let hideListTimeout=null;

function populateChannelList(){
  channelListContainer.innerHTML='';
  (combinedChannels||[]).forEach(ch=>{
    const item=document.createElement('div');
    item.className='channel-item';
    item.innerHTML=`<img src="${ch.logo||'logo.png'}"><span>${ch.name}</span>`;
    item.onclick=()=>openPlayer(ch);
    channelListContainer.appendChild(item);
  });
}
playerWrap.addEventListener('click',()=>{
  videoChannelList.classList.add('active');
  clearTimeout(hideListTimeout);
  hideListTimeout=setTimeout(()=>videoChannelList.classList.remove('active'),6000);
});
const oldOpenPlayer=openPlayer;
openPlayer=async function(ch){ await oldOpenPlayer(ch); populateChannelList(); };

/* =============== Init =============== */
window.addEventListener('load',()=>{
  renderHome('');
  if('serviceWorker' in navigator)
    navigator.serviceWorker.register('/service-worker.js').catch(()=>{});
});
</script>
</body>
</html>
