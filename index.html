<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NZM IPTV ‚Äî Clean Player</title>

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#071025" />
  <link rel="icon" href="nzm.png">

  <!-- HLS + DASH -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.0/hls.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.6/shaka-player.compiled.min.js"></script>

  <!-- Channels -->
  <script src="channels.js"></script>

  <style>
    :root{
      --bg:#050509; --panel:rgba(255,255,255,0.02); --glass:rgba(255,255,255,0.03);
      --accent1:#00d2ff; --accent2:#6a5cff; --text:#e9f6ff; --muted:rgba(233,246,255,0.55);
      --neon:0 8px 30px rgba(0,210,255,0.08),0 4px 10px rgba(106,92,255,0.04);
    }
    *{box-sizing:border-box;font-family:Inter,Poppins,Arial,sans-serif}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#030205 0%,#050509 100%);color:var(--text)}
    .app{display:flex;flex-direction:column;height:100vh;overflow:hidden}

    /* --- Topbar --- */
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;
      backdrop-filter:blur(8px);background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
      border-bottom:1px solid rgba(255,255,255,0.03);box-shadow:0 6px 30px rgba(0,0,0,0.6);}
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{height:38px;border-radius:8px;filter:drop-shadow(0 6px 18px rgba(0,0,0,0.6));}
    .brand h1{font-size:18px;color:var(--accent1);margin:0;text-shadow:0 2px 10px rgba(0,0,0,0.6)}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}

    /* --- Search --- */
    .search{min-width:220px;display:flex;align-items:center;padding:8px 12px;
      background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
      border-radius:26px;gap:10px;border:1px solid rgba(255,255,255,0.03);backdrop-filter:blur(6px);}
    .search input{background:transparent;border:none;outline:none;color:var(--text);width:100%;font-size:14px}

    /* --- Buttons --- */
    .btn{padding:8px 12px;border-radius:12px;background:transparent;border:1px solid rgba(255,255,255,0.04);
      cursor:pointer;color:var(--text);font-weight:600;backdrop-filter:blur(4px);}
    .btn.glow{box-shadow:var(--neon);background:linear-gradient(90deg,rgba(0,210,255,0.06),rgba(106,92,255,0.04));}
    .btn.glow:hover{transform:translateY(-2px);filter:brightness(1.06)}

    /* --- Content --- */
    .content{flex:1;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:18px}
    .row{display:flex;flex-direction:column;gap:10px}
    .row-header{display:flex;align-items:center;justify-content:space-between;padding:0 6px}
    .row-title{font-size:16px;color:var(--muted);display:flex;gap:10px;align-items:center}
    .carousel{display:flex;gap:12px;overflow:auto;padding:12px 6px;scroll-snap-type:x mandatory;scroll-behavior:smooth}
    .carousel::-webkit-scrollbar{height:8px}
    .carousel::-webkit-scrollbar-thumb{background:linear-gradient(90deg,var(--accent1),var(--accent2));border-radius:8px}

    /* --- Cards --- */
    .card{min-width:220px;height:132px;border-radius:12px;
      background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;
      padding:10px;cursor:pointer;position:relative;scroll-snap-align:center;
      transition:transform .18s ease,box-shadow .18s ease;border:1px solid rgba(255,255,255,0.03);}
    .card:hover{transform:translateY(-6px) scale(1.03);box-shadow:0 14px 40px rgba(0,0,0,0.6)}
    .card img{width:110px;height:70px;border-radius:8px;object-fit:cover}
    .card .name{font-size:14px;color:var(--text);text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%}
    .badge-live{position:absolute;left:10px;top:10px;background:linear-gradient(90deg,var(--accent1),var(--accent2));
      padding:4px 6px;border-radius:6px;font-size:11px;color:#fff}
    .fav-toggle{position:absolute;right:10px;top:10px;background:rgba(0,0,0,0.45);
      padding:6px;border-radius:8px;color:var(--accent1);cursor:pointer}

    /* --- Player + Overlay --- */
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:linear-gradient(180deg,rgba(3,6,12,0.6),rgba(0,0,0,0.85));z-index:100}
    .overlay.active{display:flex}
    .player-wrap{width:92%;max-width:1280px;aspect-ratio:16/9;background:#000;border-radius:14px;overflow:hidden;
      position:relative;box-shadow:0 30px 80px rgba(0,0,0,0.7)}
    video,iframe{width:100%;height:100%;display:block;background:#000}

    .steady-banner{position:absolute;top:14px;right:14px;display:flex;align-items:center;gap:10px;
      padding:8px 12px;border-radius:10px;background:rgba(0,0,0,0.6);color:#fff;z-index:60;
      backdrop-filter:blur(6px);font-weight:600;font-size:14px;box-shadow:0 8px 30px rgba(0,0,0,0.6);opacity:0;
      transform:translateY(-6px);transition:opacity .28s ease,transform .28s ease;}
    .player-wrap:fullscreen .steady-banner,
    .player-wrap:-webkit-full-screen .steady-banner{opacity:1;transform:translateY(0);}
    .steady-banner img{width:44px;height:30px;border-radius:6px;object-fit:cover}

    .player-controls-bottom{position:absolute;right:16px;bottom:16px;display:flex;gap:8px;z-index:50;}
    .player-controls-bottom button{background:rgba(0,0,0,0.5);border:none;color:#fff;padding:10px;border-radius:10px;
      cursor:pointer;backdrop-filter:blur(4px);}
    .player-controls-bottom button:hover{background:rgba(0,0,0,0.7);}

    /* --- Spinner --- */
    .loading-spinner{position:absolute;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,0.45);z-index:60;}
    .spinner{width:56px;height:56px;border:6px solid rgba(255,255,255,0.12);
      border-top-color:var(--accent1);border-radius:50%;animation:spin .8s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* --- Install popup --- */
    #installPopup{display:none;position:fixed;bottom:24px;left:50%;transform:translateX(-50%);
      background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;padding:12px 18px;
      border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.6);z-index:9999;font-weight:500;}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand"><img src="nzmm.png" alt="logo"><h1>NZM IPTV</h1></div>
      <div class="controls">
        <div class="search">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <input id="searchInput" placeholder="Search channels or categories (press / to focus)"/>
        </div>
        <button id="installBtn" class="btn glow" style="display:none;">üì≤ Install</button>
        <button id="favoritesTab" class="btn glow">‚ù§ Favorites</button>
      </div>
    </div>

    <div class="content" id="content"></div>

    <!-- Install popup -->
<div id="installPopup">
  Install NZM IPTV for quick access üì≤
  <button id="popupInstall" class="btn" style="background:#fff;color:#000;margin-left:8px;">Install</button>
</div>

<script>
/* ------------------- STATE ------------------- */
let favorites = JSON.parse(localStorage.getItem("iptv_favs") || "[]");
const content = document.getElementById("content");
const searchInput = document.getElementById("searchInput");
const favoritesTab = document.getElementById("favoritesTab");

/* ------------------- PLAYER OVERLAY ------------------- */
const overlay = document.createElement("div");
overlay.className = "overlay";
overlay.innerHTML = `
  <div class="player-wrap" id="playerWrap">
    <div class="loading-spinner" id="loadingSpinner"><div class="spinner"></div></div>
    <video id="playerVideo" playsinline></video>
    <div class="steady-banner" id="steadyBanner">
      <img id="npLogo" src="" alt="logo"><span id="npTitle">Now Playing</span>
    </div>
    <div class="player-controls-bottom">
      <button id="minimizeBtn" title="Minimize to PiP">‚§¢</button>
    </div>
  </div>`;
document.body.appendChild(overlay);

const playerVideo = overlay.querySelector("#playerVideo");
const loadingSpinner = overlay.querySelector("#loadingSpinner");
const npLogo = overlay.querySelector("#npLogo");
const npTitle = overlay.querySelector("#npTitle");
const minimizeBtn = overlay.querySelector("#minimizeBtn");
let hls = null;

/* ------------------- HELPERS ------------------- */
function stopPlayback(){
  if(hls){try{hls.destroy();}catch{} hls=null;}
  playerVideo.pause(); playerVideo.removeAttribute("src"); playerVideo.load();
}
function showSpinner(){loadingSpinner.style.display="flex";}
function hideSpinner(){loadingSpinner.style.display="none";}

/* ------------------- OPEN PLAYER ------------------- */
async function openPlayer(ch){
  stopPlayback();
  overlay.classList.add("active");
  showSpinner();
  npLogo.src = ch.logo || "logo.png";
  npTitle.textContent = ch.name || "Now Playing";

  // Enter fullscreen landscape
  const wrap = overlay.querySelector("#playerWrap");
  try{
    if(!document.fullscreenElement){
      await wrap.requestFullscreen();
      if(screen.orientation?.lock) screen.orientation.lock("landscape").catch(()=>{});
    }
  }catch{}

  // Load source
  if(Hls.isSupported()){
    hls = new Hls();
    hls.loadSource(ch.url);
    hls.attachMedia(playerVideo);
    hls.on(Hls.Events.MANIFEST_PARSED, ()=>{hideSpinner(); playerVideo.play().catch(()=>{});});
  }else if(playerVideo.canPlayType("application/vnd.apple.mpegurl")){
    playerVideo.src = ch.url;
    playerVideo.oncanplay = ()=>{hideSpinner(); playerVideo.play().catch(()=>{});};
  }else{
    playerVideo.src = ch.url;
    playerVideo.onloadeddata = ()=>{hideSpinner(); playerVideo.play().catch(()=>{});};
  }
}

/* ------------------- PIP / MINIMIZE ------------------- */
minimizeBtn.onclick = async ()=>{
  try{
    await playerVideo.requestPictureInPicture();
    overlay.classList.remove("active"); // hide overlay completely
  }catch{ alert("PiP not supported"); }
};
playerVideo.addEventListener("leavepictureinpicture", stopPlayback);

/* ------------------- ESC CLOSE ------------------- */
document.addEventListener("keydown", e=>{
  if(e.key==="Escape"){ 
    if(document.fullscreenElement) document.exitFullscreen().catch(()=>{});
    overlay.classList.remove("active"); stopPlayback();
  }
});

/* ------------------- UI: FAVORITES & CHANNELS ------------------- */
function toggleFav(n, el){
  const i=favorites.indexOf(n);
  if(i===-1){favorites.push(n);el.textContent="‚ù§";}
  else{favorites.splice(i,1);el.textContent="‚ô°";}
  localStorage.setItem("iptv_favs",JSON.stringify(favorites));
}
function groupChannels(list){
  const g={};
  (list||[]).forEach(c=>{
    const cat=c.category||c.group||c["group-title"]||"Uncategorized";
    if(!g[cat]) g[cat]=[];
    g[cat].push(c);
  });
  return g;
}
function scrollRow(b,d){
  b.closest(".row-header").nextElementSibling.scrollBy({left:d*420,behavior:"smooth"});
}
function createRow(title,chs){
  const r=document.createElement("div");r.className="row";
  const h=document.createElement("div");h.className="row-header";
  h.innerHTML=`<div class="row-title"><strong>${title}</strong></div>
               <div><button class="btn" onclick="scrollRow(this,-1)">‚óÄ</button>
               <button class="btn" onclick="scrollRow(this,1)">‚ñ∂</button></div>`;
  const car=document.createElement("div");car.className="carousel";
  chs.forEach(c=>{
    const card=document.createElement("div");card.className="card";
    card.innerHTML=`${c.live?'<div class="badge-live">LIVE</div>':''}
      <div class="fav-toggle" data-name="${c.name}">${favorites.includes(c.name)?'‚ù§':'‚ô°'}</div>
      <img src="${c.logo||'logo.png'}"><div class="name">${c.name}</div>`;
    card.querySelector(".fav-toggle").onclick=(ev)=>{ev.stopPropagation();toggleFav(c.name,ev.target);};
    card.onclick=()=>openPlayer(c);
    car.appendChild(card);
  });
  r.appendChild(h);r.appendChild(car);content.appendChild(r);
}
function renderHome(f=""){
  content.innerHTML="";
  const grouped=groupChannels(channels||[]);
  const favs=(channels||[]).filter(c=>favorites.includes(c.name));
  if(favs.length) createRow("Favorites",favs);
  Object.keys(grouped).forEach(cat=>{
    const rows=grouped[cat].filter(ch=>ch.name.toLowerCase().includes(f.toLowerCase()));
    if(rows.length) createRow(cat,rows);
  });
}
searchInput.oninput=e=>renderHome(e.target.value);
favoritesTab.onclick=()=>renderHome("");

/* ------------------- PWA INSTALL ------------------- */
let deferredPrompt;
const installBtn=document.getElementById("installBtn");
const popup=document.getElementById("installPopup");
const popupInstall=document.getElementById("popupInstall");

window.addEventListener("beforeinstallprompt",e=>{
  e.preventDefault(); deferredPrompt=e;
  installBtn.style.display="inline-block";
  setTimeout(()=>popup.style.display="flex",3000);
});
async function showInstallPrompt(){
  if(!deferredPrompt){popup.style.display="none";return;}
  deferredPrompt.prompt();
  const {outcome}=await deferredPrompt.userChoice;
  if(outcome==="accepted"){installBtn.textContent="‚úÖ Installed";}
  popup.style.display="none"; deferredPrompt=null;
}
installBtn.onclick=showInstallPrompt;
popupInstall.onclick=showInstallPrompt;

/* ------------------- INIT ------------------- */
window.addEventListener("load",()=>{
  renderHome("");
  if("serviceWorker" in navigator)
    navigator.serviceWorker.register("/service-worker.js").catch(()=>{});
});
</script>
</body>
</html>
