<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NZM IPTV ‚Äî Clean Player</title>

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#071025" />
  <link rel="icon" href="nzm.png">

  <!-- HLS + DASH -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.0/hls.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.6/shaka-player.compiled.min.js"></script>

  <!-- Channels -->
  <script src="channels.js"></script>

  <style>
    :root{
      --bg:#050509;
      --panel:rgba(255,255,255,0.02);
      --glass: rgba(255,255,255,0.03);
      --accent1:#00d2ff;
      --accent2:#6a5cff;
      --text:#e9f6ff;
      --muted:rgba(233,246,255,0.55);
      --neon: 0 8px 30px rgba(0,210,255,0.08), 0 4px 10px rgba(106,92,255,0.04);
    }
    *{box-sizing:border-box;font-family:Inter,Poppins,Arial,sans-serif}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#030205,#050509);color:var(--text)}
    .app{display:flex;flex-direction:column;height:100vh;overflow:hidden}

    .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;
      backdrop-filter:blur(8px) saturate(1.1);
      background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
      border-bottom:1px solid rgba(255,255,255,0.03);
      box-shadow:0 6px 30px rgba(0,0,0,0.6);}
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{height:38px;border-radius:8px;filter:drop-shadow(0 6px 18px rgba(0,0,0,0.6))}
    .brand h1{font-size:18px;color:var(--accent1);margin:0;text-shadow:0 2px 10px rgba(0,0,0,0.6)}

    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .search{min-width:220px;display:flex;align-items:center;padding:8px 12px;
      background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
      border-radius:26px;gap:10px;border:1px solid rgba(255,255,255,0.03);backdrop-filter:blur(6px);}
    .search input{background:transparent;border:none;outline:none;color:var(--text);width:100%;font-size:14px}

    .btn{padding:8px 12px;border-radius:12px;background:transparent;border:1px solid rgba(255,255,255,0.04);
      cursor:pointer;color:var(--text);font-weight:600;backdrop-filter:blur(4px);}
    .btn.glow{border:1px solid rgba(0,0,0,0.2);box-shadow:var(--neon);
      background:linear-gradient(90deg,rgba(0,210,255,0.06),rgba(106,92,255,0.04));}
    .icon-btn{padding:8px;border-radius:10px;background:var(--panel);cursor:pointer;border:none;color:var(--text)}

    .content{flex:1;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:18px}
    .row{display:flex;flex-direction:column;gap:10px}
    .row-header{display:flex;align-items:center;justify-content:space-between;padding:0 6px}
    .carousel{display:flex;gap:12px;overflow:auto;padding:12px 6px;scroll-snap-type:x mandatory;scroll-behavior:smooth}

    .card{min-width:220px;height:132px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;padding:10px;cursor:pointer;position:relative;scroll-snap-align:center;
      transition:transform .18s ease,box-shadow .18s ease;border:1px solid rgba(255,255,255,0.03)}
    .card:hover{transform:translateY(-6px) scale(1.03);box-shadow:0 14px 40px rgba(0,0,0,0.6)}

    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:linear-gradient(180deg,rgba(3,6,12,0.6),rgba(0,0,0,0.85));z-index:100}
    .overlay.active{display:flex}
    .player-wrap{width:92%;max-width:1280px;aspect-ratio:16/9;background:#000;border-radius:14px;overflow:hidden;
      position:relative;box-shadow:0 30px 80px rgba(0,0,0,0.7)}
    video,iframe{width:100%;height:100%;display:block;background:#000}

    .player-ui{position:absolute;right:16px;top:16px;display:flex;flex-direction:column;gap:8px;z-index:30;align-items:flex-end}
    .close-btn{position:absolute;left:12px;top:12px;background:rgba(0,0,0,0.6);padding:8px;border-radius:10px;color:#fff;cursor:pointer;z-index:40}
    .steady-banner{position:absolute;top:14px;right:14px;display:flex;align-items:center;gap:10px;
      padding:8px 12px;border-radius:10px;background:rgba(0,0,0,0.6);color:#fff;z-index:60;
      backdrop-filter:blur(6px);font-weight:600;font-size:14px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    .steady-banner img{width:44px;height:30px;border-radius:6px;object-fit:cover}

    .player-controls-bottom{position:absolute;right:16px;bottom:16px;display:flex;gap:8px;z-index:50;align-items:center}
    .player-controls-bottom button{background:rgba(0,0,0,0.5);border:none;color:#fff;padding:10px;border-radius:10px;cursor:pointer;backdrop-filter:blur(4px)}

    /* Hide unwanted default controls and extra buttons */
    video::-webkit-media-controls-panel,
    video::-webkit-media-controls-enclosure,
    video::-webkit-media-controls,
    video::-webkit-media-controls-volume-slider,
    video::-webkit-media-controls-play-button,
    video::-webkit-media-controls-timeline,
    video::-webkit-media-controls-current-time-display,
    video::-webkit-media-controls-fullscreen-button,
    video::-webkit-media-controls-mute-button,
    video::-webkit-media-controls-toggle-closed-captions-button {
      display:none !important;opacity:0 !important;visibility:hidden !important;
    }

    /* Hide all bottom custom controls except minimize (PiP) */
    .player-controls-bottom button:not(#pipBtn),
    .player-controls-bottom .vol-wrap {
      display:none !important;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand"><img src="nzmm.png"><h1>NZM IPTV</h1></div>
      <div class="controls">
        <div class="search">
          <input id="searchInput" placeholder="Search channels or categories (press / to focus)" />
        </div>
        <button id="installBtn" class="btn glow" style="display:none;">üì≤ Install</button>
        <button id="favoritesTab" class="btn glow">‚ù§ Favorites</button>
      </div>
    </div>

    <div class="content" id="content"></div>

    <div class="overlay" id="overlay" aria-hidden="true">
      <div class="player-wrap" id="playerWrap">
        <button class="close-btn" id="exitPlayer" aria-label="Close">‚úñ</button>
        <div class="steady-banner" id="steadyBanner">
          <img id="steadyLogo" src="logo.png" alt="logo"><div id="steadyTitle">‚Äî</div>
        </div>
        <div class="player-controls-bottom">
          <button id="pipBtn" title="Picture-in-Picture">‚§¢</button>
        </div>
        <video id="playerVideo" playsinline preload="auto" style="background:#000;outline:none;"
          controlslist="nodownload noplaybackrate nofullscreen noremoteplayback" disablepictureinpicture></video>
        <iframe id="playerIframe" allowfullscreen style="display:none;"></iframe>
      </div>
  </div>

    <script>
/* ====== State ====== */
let favorites = JSON.parse(localStorage.getItem('iptv_favs') || '[]');
let lastPlayed = JSON.parse(localStorage.getItem('lastPlayed') || 'null');

const content = document.getElementById('content'),
      overlay = document.getElementById('overlay'),
      playerVideo = document.getElementById('playerVideo'),
      playerIframe = document.getElementById('playerIframe'),
      steadyBanner = document.getElementById('steadyBanner'),
      steadyLogo = document.getElementById('steadyLogo'),
      steadyTitle = document.getElementById('steadyTitle'),
      pipBtn = document.getElementById('pipBtn'),
      exitPlayer = document.getElementById('exitPlayer'),
      favoritesTab = document.getElementById('favoritesTab'),
      searchInput = document.getElementById('searchInput');

let hls = null, shakaPlayer = null;

/* ====== Spinner helpers ====== */
function showSpinner(){const s=document.getElementById('loadingSpinner');if(s)s.style.display='flex';}
function hideSpinner(){const s=document.getElementById('loadingSpinner');if(s)s.style.display='none';}

/* ====== Stop any active playback ====== */
function stopAllPlayers(){
  if(hls){try{hls.destroy();}catch(e){}hls=null;}
  if(shakaPlayer){try{shakaPlayer.unload();}catch(e){}shakaPlayer=null;}
  try{playerVideo.pause();playerVideo.removeAttribute('src');playerVideo.load();}catch(e){}
  try{playerIframe.src='';}catch(e){}
  playerVideo.style.display='none';
  playerIframe.style.display='none';
  hideSpinner();
}

/* ====== Open Player ====== */
async function openPlayer(ch){
  stopAllPlayers();
  overlay.classList.add('active');
  overlay.setAttribute('aria-hidden','false');
  showSpinner();

  steadyLogo.src = ch.logo || 'logo.png';
  steadyTitle.textContent = ch.name || '‚Äî';

  lastPlayed = {name:ch.name,url:ch.url,type:ch.type,logo:ch.logo,time:new Date().toLocaleString(),clearKey:ch.clearKey||null};
  localStorage.setItem('lastPlayed', JSON.stringify(lastPlayed));

  playerVideo.preload = 'auto';
  playerVideo.autoplay = true;
  playerVideo.muted = false;
  playerVideo.style.display='none';
  playerIframe.style.display='none';

  try {
    if(ch.type==='youtube'){
      playerIframe.style.display='block';
      playerIframe.src = ch.url + (ch.url.includes('?')?'&':'?') + 'autoplay=1';
      hideSpinner();
    } else if(ch.type==='hls'){
      playerVideo.style.display='block';
      if (Hls.isSupported()){
        hls = new Hls({maxRetries:3});
        hls.attachMedia(playerVideo);
        hls.on(Hls.Events.MANIFEST_PARSED, ()=>{hideSpinner();playerVideo.play().catch(()=>{});});
        hls.loadSource(ch.url);
      } else {playerVideo.src = ch.url;playerVideo.play().catch(()=>{});hideSpinner();}
    } else if(ch.type==='dash'){
      playerVideo.style.display='block';
      if (shaka.Player.isBrowserSupported()){
        shaka.polyfill.installAll();
        shakaPlayer = new shaka.Player(playerVideo);
        if(ch.clearKey) shakaPlayer.configure({drm:{clearKeys:ch.clearKey}});
        await shakaPlayer.load(ch.url);
        playerVideo.play().catch(()=>{});
      }
      hideSpinner();
    } else {
      playerVideo.style.display='block';
      playerVideo.src = ch.url;
      playerVideo.play().catch(()=>{});
      hideSpinner();
    }
  } catch(err){console.error(err);hideSpinner();}
}

/* ====== Controls ====== */
exitPlayer.onclick = async ()=>{
  try{if(document.fullscreenElement)await document.exitFullscreen();}catch(e){}
  stopAllPlayers();
  overlay.classList.remove('active');
  overlay.setAttribute('aria-hidden','true');
};

/* ====== Picture-in-Picture (PiP) ====== */
pipBtn.onclick = async ()=>{
  try{
    if(!document.pictureInPictureElement){
      await playerVideo.requestPictureInPicture();
    }else{
      await document.exitPictureInPicture();
    }
  }catch(err){
    overlay.classList.remove('active');
    overlay.setAttribute('aria-hidden','true');
  }
};

/* Hide overlay when PiP starts */
playerVideo.addEventListener('enterpictureinpicture',()=>{
  overlay.classList.remove('active');
  overlay.setAttribute('aria-hidden','true');
});

/* Show overlay again when PiP ends */
playerVideo.addEventListener('leavepictureinpicture',()=>{
  overlay.classList.add('active');
  overlay.setAttribute('aria-hidden','false');
});

/* ====== Search + Rendering ====== */
searchInput.oninput = e => renderHome(e.target.value || '');
function groupChannels(list){const g={};(list||[]).forEach(c=>{const cat=c.category||c.group||c['group-title']||'Uncategorized';if(!g[cat])g[cat]=[];g[cat].push(c);});return g;}
function createRow(title,chs){
  const r=document.createElement('div');r.className='row';
  const h=document.createElement('div');h.className='row-header';
  h.innerHTML=`<div class="row-title"><strong>${title}</strong></div>`;
  const car=document.createElement('div');car.className='carousel';
  chs.forEach(c=>{
    const card=document.createElement('div');card.className='card';
    card.innerHTML=`<img src="${c.logo||'logo.png'}"><div class="name">${c.name}</div>`;
    card.addEventListener('click',()=>openPlayer(c));
    car.appendChild(card);
  });
  r.appendChild(h);r.appendChild(car);content.appendChild(r);
}
function renderHome(f=''){
  content.innerHTML='';
  const g=groupChannels(combinedChannels||[]);
  Object.keys(g).forEach(cat=>{
    const rows=g[cat].filter(ch=>ch.name.toLowerCase().includes(f.toLowerCase())||cat.toLowerCase().includes(f.toLowerCase()));
    if(rows.length)createRow(cat,rows);
  });
}
favoritesTab.onclick=()=>renderHome('');

/* ====== Keyboard shortcut ====== */
document.addEventListener('keydown',e=>{
  if(e.key==='/'){e.preventDefault();searchInput.focus();}
  if(e.key==='Escape' && overlay.classList.contains('active'))exitPlayer.click();
});

/* ====== On load ====== */
window.addEventListener('load',()=>{
  renderHome('');
  if('serviceWorker' in navigator)navigator.serviceWorker.register('/service-worker.js').catch(()=>{});
});

/* ====== PWA INSTALL PROMPT + PREMIUM TOAST ====== */
let deferredPrompt;
const installBtn = document.getElementById('installBtn');

/* Create floating popup for install suggestion */
const popup = document.createElement('div');
popup.id = "installPopup";
popup.innerHTML = `
  Install NZM IPTV for quick access üì≤
  <button id="popupInstall" class="btn" style="background:#fff;color:#000;margin-left:8px;">Install</button>
`;
Object.assign(popup.style,{
  display:"none",
  position:"fixed",
  bottom:"24px",
  left:"50%",
  transform:"translateX(-50%)",
  background:"linear-gradient(90deg,var(--accent1),var(--accent2))",
  color:"#fff",
  padding:"12px 18px",
  borderRadius:"12px",
  boxShadow:"0 10px 30px rgba(0,0,0,0.6)",
  zIndex:"9999",
  fontWeight:"500",
  alignItems:"center",
  gap:"8px"
});
document.body.appendChild(popup);

/* Create hidden toast for success animation */
const toast = document.createElement('div');
toast.id = "installToast";
toast.textContent = "‚úÖ Installed successfully";
Object.assign(toast.style,{
  display:"none",
  position:"fixed",
  bottom:"30px",
  left:"50%",
  transform:"translateX(-50%)",
  background:"rgba(0,0,0,0.75)",
  color:"var(--accent1)",
  padding:"12px 22px",
  borderRadius:"12px",
  fontWeight:"600",
  boxShadow:"0 0 20px rgba(0,210,255,0.3)",
  backdropFilter:"blur(6px)",
  zIndex:"9999",
  opacity:"0",
  transition:"opacity .4s ease, transform .4s ease"
});
document.body.appendChild(toast);

/* Animate the toast (fade-in / fade-out) */
function showToast(){
  toast.style.display="block";
  requestAnimationFrame(()=>{
    toast.style.opacity="1";
    toast.style.transform="translate(-50%, -10px)";
  });
  setTimeout(()=>{
    toast.style.opacity="0";
    toast.style.transform="translate(-50%, 20px)";
    setTimeout(()=>toast.style.display="none",400);
  },2200);
}

/* Listen for install availability */
window.addEventListener('beforeinstallprompt', e=>{
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display='inline-block';
  setTimeout(()=>popup.style.display='flex',3000);
});

/* Show native browser prompt */
async function showInstallPrompt(){
  if(!deferredPrompt){ popup.style.display='none'; return; }
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  if(outcome==='accepted'){
    installBtn.textContent='‚úÖ Installed';
    showToast();
  }
  popup.style.display='none';
  deferredPrompt=null;
}

/* Buttons */
popup.querySelector('#popupInstall').onclick = showInstallPrompt;
installBtn.onclick = showInstallPrompt;
      
</script>
</body>
  </html>
